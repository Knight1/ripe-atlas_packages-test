language: shell
services:
- docker
os: linux
dist: bionic

before_install:
  - curl -L https://goss.rocks/install | sudo sh
  - sudo apt-get -y install qemu-user-static
  - docker run --rm --privileged multiarch/qemu-user-static:register
  - sudo apt install git tar fakeroot libssl-dev autoconf automake libtool build-essential fakeroot -y
  - cat /proc/cpuinfo
  - dig @resolver1.opendns.com ANY myip.opendns.com +short
addons:
  apt:
    update: true

stages:
  - build
  - name: deploy
    if: branch = master
deploy:
  provider: releases
  edge: true
  file: "*.deb"
  cleanup: false
  on:
    tags: false

jobs:
  include:
    - stage: build
      name: Build ARM64
      arch: arm64
      script:
        - git clone --recursive https://github.com/RIPE-NCC/ripe-atlas-software-probe.git
        - sudo ./ripe-atlas-software-probe/build-config/debian/bin/make-deb
        - mv *.deb atlasswprobe-5000-"$TRAVIS_CPU_ARCH".deb
        - file *.deb
        - sudo dpkg -i *.deb
        - sleep 10
        - sudo systemctl status atlas -l
    - stage: build
      name: Build AMD64
      arch: amd64
      script:
        - git clone --recursive https://github.com/RIPE-NCC/ripe-atlas-software-probe.git
        - sudo ./ripe-atlas-software-probe/build-config/debian/bin/make-deb
        - mv *.deb atlasswprobe-5000-"$TRAVIS_CPU_ARCH".deb
        - sudo dpkg -i *.deb
        - sleep 10
        - sudo systemctl status atlas -l
    - stage: deploy
      script: 
        - docker login docker.pkg.github.com --username Knight1
        - wget https://github.com/estesp/manifest-tool/releases/download/v1.0.0/manifest-tool-linux-amd64
        - chmod +x manifest-tool-linux-amd64
        - ./manifest-tool-linux-amd64
        - if [[ "$TRAVIS_BRANCH" == "test" ]]; then ./manifest-tool-linux-amd64 push from-args --platforms linux/amd64,linux/arm,linux/arm64 --template knight/cloudflared-dns:amd64 --target knight/cloudflared-dns:latest; fi
      env: TAG=amd64
